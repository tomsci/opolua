_ENV = module()

fns = {
    [1] = "BackLightOn",
    [2] = "SetBackLightOn",
    [3] = "SetBackLightOnTime",
    [4] = "SetBacklightBehavior",
    [5] = "IsBacklightPresent",
    [6] = "SetAutoSwitchOffBehavior",
    [7] = "SetAutoSwitchOffTime",
    [8] = "SetActive",
    [9] = "ResetAutoSwitchOffTimer",
    [10] = "SwitchOff",
    [11] = "SetSoundEnabled",
    [12] = "SetSoundDriverEnabled",
    [13] = "SetKeyClickEnabled",
    [14] = "SetPointerClickEnabled",
    [15] = "SetDisplayContrast",
    [16] = "MaxDisplayContrast",
    [17] = "IsReadOnly",
    [18] = "IsHidden",
    [19] = "IsSystem",
    [20] = "SetReadOnly",
    [21] = "SetHiddenFile",
    [22] = "SetSystemFile",
    [23] = "VolumeSize",
    [24] = "VolumeSpaceFree",
    [25] = "VolumeUniqueID",
    [26] = "MediaType",
    [27] = "GetFileTime",
    [28] = "SetFileTime",
    [29] = "DisplayTaskList",
    [30] = "SetComputeMode",
    [31] = "RunApp",
    [32] = "RunExe",
    [33] = "LogonToThread",
    [34] = "TerminateCurrentProcess",
    [35] = "TerminateProcess",
    [36] = "KillCurrentProcess",
    [37] = "KillProcess",
    [38] = "PlaySound",
    [39] = "PlaySoundA",
    [40] = "StopSound",
    [41] = "Mod",
    [42] = "XOR",
    [43] = "LoadRsc",
    [44] = "UnLoadRsc",
    [45] = "ReadRsc",
    [46] = "ReadRscLong",
    [47] = "CheckUid",
    [48] = "SetPointerGrabOn",
    [49] = "MachineName",
    [50] = "MachineUniqueId",
    [51] = "EndTask",
    [52] = "KillTask",
    [53] = "GetThreadIdFromOpenDoc",
    [54] = "GetThreadIdFromAppUid",
    [55] = "SetForeground",
    [56] = "SetBackground",
    [57] = "SetForegroundByThread",
    [58] = "SetBackgroundByThread",
    [59] = "GetNextWindowGroupName",
    [60] = "GetNextWindowId",
    [61] = "SendKeyEventToApp",
    [62] = "IrDAConnectToSend",
    [63] = "IrDAConnectToReceive",
    [64] = "IrDAWrite",
    [65] = "IrDARead",
    [66] = "IrDAReadA",
    [67] = "IrDAWaitForDisconnect",
    [68] = "IrDADisconnect",
    [69] = "MainBatteryStatus",
    [70] = "BackupBatteryStatus",
    [71] = "CaptureKey",
    [72] = "CancelCaptureKey",
    [73] = "SetPointerCapture",
    [74] = "ClaimPointerGrab",
    [75] = "OpenFileDialog",
    [76] = "CreateFileDialog",
    [77] = "SaveAsFileDialog",
}

function BackLightOn(stack, runtime) -- 1
    error("Unimplemented system.opx function BackLightOn!")
end

function SetBackLightOn(stack, runtime) -- 2
    error("Unimplemented system.opx function SetBackLightOn!")
end

function SetBackLightOnTime(stack, runtime) -- 3
    error("Unimplemented system.opx function SetBackLightOnTime!")
end

function SetBacklightBehavior(stack, runtime) -- 4
    error("Unimplemented system.opx function SetBacklightBehavior!")
end

function IsBacklightPresent(stack, runtime) -- 5
    error("Unimplemented system.opx function IsBacklightPresent!")
end

function SetAutoSwitchOffBehavior(stack, runtime) -- 6
    error("Unimplemented system.opx function SetAutoSwitchOffBehavior!")
end

function SetAutoSwitchOffTime(stack, runtime) -- 7
    error("Unimplemented system.opx function SetAutoSwitchOffTime!")
end

function SetActive(stack, runtime) -- 8
    error("Unimplemented system.opx function SetActive!")
end

function ResetAutoSwitchOffTimer(stack, runtime) -- 9
    error("Unimplemented system.opx function ResetAutoSwitchOffTimer!")
end

function SwitchOff(stack, runtime) -- 10
    error("Unimplemented system.opx function SwitchOff!")
end

function SetSoundEnabled(stack, runtime) -- 11
    error("Unimplemented system.opx function SetSoundEnabled!")
end

function SetSoundDriverEnabled(stack, runtime) -- 12
    error("Unimplemented system.opx function SetSoundDriverEnabled!")
end

function SetKeyClickEnabled(stack, runtime) -- 13
    error("Unimplemented system.opx function SetKeyClickEnabled!")
end

function SetPointerClickEnabled(stack, runtime) -- 14
    error("Unimplemented system.opx function SetPointerClickEnabled!")
end

function SetDisplayContrast(stack, runtime) -- 15
    error("Unimplemented system.opx function SetDisplayContrast!")
end

function MaxDisplayContrast(stack, runtime) -- 16
    error("Unimplemented system.opx function MaxDisplayContrast!")
end

function IsReadOnly(stack, runtime) -- 17
    error("Unimplemented system.opx function IsReadOnly!")
end

function IsHidden(stack, runtime) -- 18
    error("Unimplemented system.opx function IsHidden!")
end

function IsSystem(stack, runtime) -- 19
    error("Unimplemented system.opx function IsSystem!")
end

function SetReadOnly(stack, runtime) -- 20
    error("Unimplemented system.opx function SetReadOnly!")
end

function SetHiddenFile(stack, runtime) -- 21
    error("Unimplemented system.opx function SetHiddenFile!")
end

function SetSystemFile(stack, runtime) -- 22
    error("Unimplemented system.opx function SetSystemFile!")
end

function VolumeSize(stack, runtime) -- 23
    error("Unimplemented system.opx function VolumeSize!")
end

function VolumeSpaceFree(stack, runtime) -- 24
    error("Unimplemented system.opx function VolumeSpaceFree!")
end

function VolumeUniqueID(stack, runtime) -- 25
    error("Unimplemented system.opx function VolumeUniqueID!")
end

function MediaType(stack, runtime) -- 26
    error("Unimplemented system.opx function MediaType!")
end

function GetFileTime(stack, runtime) -- 27
    error("Unimplemented system.opx function GetFileTime!")
end

function SetFileTime(stack, runtime) -- 28
    error("Unimplemented system.opx function SetFileTime!")
end

function DisplayTaskList(stack, runtime) -- 29
    error("Unimplemented system.opx function DisplayTaskList!")
end

function SetComputeMode(stack, runtime) -- 30
    local state = stack:pop()
    -- We don't care about scheduling
    stack:push(0)
end

function RunApp(stack, runtime) -- 31
    error("Unimplemented system.opx function RunApp!")
end

function RunExe(stack, runtime) -- 32
    error("Unimplemented system.opx function RunExe!")
end

function LogonToThread(stack, runtime) -- 33
    error("Unimplemented system.opx function LogonToThread!")
end

function TerminateCurrentProcess(stack, runtime) -- 34
    error("Unimplemented system.opx function TerminateCurrentProcess!")
end

function TerminateProcess(stack, runtime) -- 35
    error("Unimplemented system.opx function TerminateProcess!")
end

function KillCurrentProcess(stack, runtime) -- 36
    error("Unimplemented system.opx function KillCurrentProcess!")
end

function KillProcess(stack, runtime) -- 37
    error("Unimplemented system.opx function KillProcess!")
end

function PlaySound(stack, runtime) -- 38
    local var = runtime:makeTemporaryVar(DataTypes.EWord)
    stack:push(var:addressOf())
    PlaySoundA(stack, runtime)
    runtime:waitForRequest(var)
    local val = var()
    if val < 0 then
        error(val)
    end
end

function PlaySoundA(stack, runtime) -- 39
    local var = stack:pop():dereference()
    local volume = stack:pop()
    local file = stack:pop()
    var(KOplErrFilePending)

    local data, err = runtime:iohandler().fsop("read", file)
    if not data then
        var(err)
        runtime:requestSignal()
        stack:push(0) -- Should this be the error?
        return
    end

    local sndData = require("sound").parseWveFile(data)
    runtime:iohandler().asyncRequest("playsound", var, sndData)
    stack:push(0)
end

function StopSound(stack, runtime) -- 40
    error("Unimplemented system.opx function StopSound!")
end

function Mod(stack, runtime) -- 41
    local right = stack:pop()
    local left = stack:pop()
    stack:push(left % right)
end

function XOR(stack, runtime) -- 42
    local right = stack:pop()
    local left = stack:pop()
    stack:push(left ~ right)
end

function LoadRsc(stack, runtime) -- 43
    error("Unimplemented system.opx function LoadRsc!")
end

function UnLoadRsc(stack, runtime) -- 44
    error("Unimplemented system.opx function UnLoadRsc!")
end

function ReadRsc(stack, runtime) -- 45
    error("Unimplemented system.opx function ReadRsc!")
end

function ReadRscLong(stack, runtime) -- 46
    error("Unimplemented system.opx function ReadRscLong!")
end

function CheckUid(stack, runtime) -- 47
    error("Unimplemented system.opx function CheckUid!")
end

function SetPointerGrabOn(stack, runtime) -- 48
    error("Unimplemented system.opx function SetPointerGrabOn!")
end

function MachineName(stack, runtime) -- 49
    error("Unimplemented system.opx function MachineName!")
end

function MachineUniqueId(stack, runtime) -- 50
    error("Unimplemented system.opx function MachineUniqueId!")
end

function EndTask(stack, runtime) -- 51
    error("Unimplemented system.opx function EndTask!")
end

function KillTask(stack, runtime) -- 52
    error("Unimplemented system.opx function KillTask!")
end

function GetThreadIdFromOpenDoc(stack, runtime) -- 53
    error("Unimplemented system.opx function GetThreadIdFromOpenDoc!")
end

function GetThreadIdFromAppUid(stack, runtime) -- 54
    error("Unimplemented system.opx function GetThreadIdFromAppUid!")
end

function SetForeground(stack, runtime) -- 55
    error("Unimplemented system.opx function SetForeground!")
end

function SetBackground(stack, runtime) -- 56
    error("Unimplemented system.opx function SetBackground!")
end

function SetForegroundByThread(stack, runtime) -- 57
    error("Unimplemented system.opx function SetForegroundByThread!")
end

function SetBackgroundByThread(stack, runtime) -- 58
    error("Unimplemented system.opx function SetBackgroundByThread!")
end

function GetNextWindowGroupName(stack, runtime) -- 59
    error("Unimplemented system.opx function GetNextWindowGroupName!")
end

function GetNextWindowId(stack, runtime) -- 60
    error("Unimplemented system.opx function GetNextWindowId!")
end

function SendKeyEventToApp(stack, runtime) -- 61
    error("Unimplemented system.opx function SendKeyEventToApp!")
end

function IrDAConnectToSend(stack, runtime) -- 62
    error("Unimplemented system.opx function IrDAConnectToSend!")
end

function IrDAConnectToReceive(stack, runtime) -- 63
    error("Unimplemented system.opx function IrDAConnectToReceive!")
end

function IrDAWrite(stack, runtime) -- 64
    error("Unimplemented system.opx function IrDAWrite!")
end

function IrDARead(stack, runtime) -- 65
    error("Unimplemented system.opx function IrDARead!")
end

function IrDAReadA(stack, runtime) -- 66
    error("Unimplemented system.opx function IrDAReadA!")
end

function IrDAWaitForDisconnect(stack, runtime) -- 67
    error("Unimplemented system.opx function IrDAWaitForDisconnect!")
end

function IrDADisconnect(stack, runtime) -- 68
    error("Unimplemented system.opx function IrDADisconnect!")
end

function MainBatteryStatus(stack, runtime) -- 69
    error("Unimplemented system.opx function MainBatteryStatus!")
end

function BackupBatteryStatus(stack, runtime) -- 70
    error("Unimplemented system.opx function BackupBatteryStatus!")
end

function CaptureKey(stack, runtime) -- 71
    error("Unimplemented system.opx function CaptureKey!")
end

function CancelCaptureKey(stack, runtime) -- 72
    error("Unimplemented system.opx function CancelCaptureKey!")
end

function SetPointerCapture(stack, runtime) -- 73
    error("Unimplemented system.opx function SetPointerCapture!")
end

function ClaimPointerGrab(stack, runtime) -- 74
    error("Unimplemented system.opx function ClaimPointerGrab!")
end

function OpenFileDialog(stack, runtime) -- 75
    error("Unimplemented system.opx function OpenFileDialog!")
end

function CreateFileDialog(stack, runtime) -- 76
    error("Unimplemented system.opx function CreateFileDialog!")
end

function SaveAsFileDialog(stack, runtime) -- 77
    error("Unimplemented system.opx function SaveAsFileDialog!")
end

return _ENV
